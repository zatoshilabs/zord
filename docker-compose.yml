version: '3.8'

services:
  zord:
    build: .
    container_name: zord-indexer
    ports:
      - "${PORT:-8080}:${API_PORT:-8080}"
    volumes:
      - zord-data:/data
    environment:
      # RPC Configuration
      ZCASH_RPC_URL: ${ZCASH_RPC_URL}
      ZCASH_RPC_USERNAME: ${ZCASH_RPC_USERNAME}
      ZCASH_RPC_PASSWORD: ${ZCASH_RPC_PASSWORD}

      # Indexing
      ZSTART_HEIGHT: ${ZSTART_HEIGHT:-3132356}

      # ZMQ (Optional)
      ZMQ_URL: ${ZMQ_URL:-}

      # API
      API_PORT: ${API_PORT:-8080}
      DB_PATH: /data/zord.db
      # API runtime tuning
      API_MAX_INFLIGHT: ${API_MAX_INFLIGHT:-2048}
      API_TIMEOUT_SECS: ${API_TIMEOUT_SECS:-15}

      # Logging
      RUST_LOG: ${RUST_LOG:-info}

    restart: unless-stopped

    # Raise file descriptor limits to avoid 'Too many open files'
    ulimits:
      nofile:
        soft: 262144
        hard: 262144

    # Optional kernel tuning for high connection churn (requires privileged Docker runtime)
    # sysctls:
    #   net.core.somaxconn: 8192
    #   net.ipv4.ip_local_port_range: 1024 65000
    #   net.ipv4.tcp_fin_timeout: 15

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${API_PORT:-8080}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  zord-data:
    driver: local
